{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>{{ location.name }}</h2>
  <p>{{ location.description }}</p>

  <!-- –ú–∞–ø–∞ -->
  <div id="map" style="height: 400px;"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
    const map = L.map('map').setView([{{ location.latitude }}, {{ location.longitude }}], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([{{ location.latitude }}, {{ location.longitude }}]).addTo(map)
      .bindPopup("{{ location.name }}").openPopup();
  </script>

  <!-- –í—ñ–¥–≥—É–∫–∏ -->
  <hr>
  <h4>–í—ñ–¥–≥—É–∫–∏</h4>
  {% for review in reviews %}
    <div class="border rounded p-2 mb-2" id="review-{{ review.id }}">
      <strong>{{ review.user.username }}</strong> ‚Äî {{ review.rating }}/5<br>
      {{ review.comment }}
      <br>
      {% if user.is_authenticated %}
        <button class="btn btn-sm btn-outline-success like-btn" data-id="{{ review.id }}">üëç {{ review.likes.count }}</button>
        <button class="btn btn-sm btn-outline-danger dislike-btn" data-id="{{ review.id }}">üëé {{ review.dislikes.count }}</button>
      {% else %}
        üëç {{ review.likes.count }} | üëé {{ review.dislikes.count }}
      {% endif %}
      {% if request.user == location.author %}
        <a href="{% url 'edit-location' location.pk %}" class="btn btn-warning">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
         <a href="{% url 'delete-location' location.pk %}" class="btn btn-danger">–í–∏–¥–∞–ª–∏—Ç–∏</a>
      {% endif %}
    </div>
  {% empty %}
    <p>–©–µ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤.</p>
  {% endfor %}

  {% if user.is_authenticated %}
  <hr>
  <h5>–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h5>
  <form method="post" class="mt-3">
    {% csrf_token %}
    
    <div class="mb-3">
      <label for="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
      {{ form.comment }}
    </div>

    <div class="mb-3">
      <label>–û—Ü—ñ–Ω–∫–∞</label>
      <div class="star-rating">
        {% for i in "54321" %}
          <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}">
          <label for="star{{ i }}">‚òÖ</label>
        {% endfor %}
      </div>
    </div>

    <button type="submit" class="btn btn-success">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
  </form>
{% else %}
  <p class="mt-3"><a href="{% url 'login' %}">–£–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.</p>
{% endif %}

</div>

<!-- AJAX –¥–ª—è –ª–∞–π–∫—ñ–≤ -->
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      fetch(`/locations/review/${id}/like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        btn.textContent = `üëç ${data.likes}`;
        btn.nextElementSibling.textContent = `üëé ${data.dislikes}`;
      });
    });
  });

  document.querySelectorAll('.dislike-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      fetch(`/locations/review/${id}/dislike/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        btn.previousElementSibling.textContent = `üëç ${data.likes}`;
        btn.textContent = `üëé ${data.dislikes}`;
      });
    });
  });
</script>
    
<style>
  .star-rating {
    direction: rtl;
    display: inline-flex;
    font-size: 2em;
    cursor: pointer;
  }
  .star-rating input {
    display: none;
  }
  .star-rating label {
    color: #ddd;
    padding: 0 2px;
  }
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: gold;
  }
</style>

{% endblock %}
